{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/map/leaflet-tracking-map.tsx"],"sourcesContent":["'use client';\n\nimport { memo, useEffect, useMemo, useRef } from 'react';\nimport {\n  MapContainer,\n  TileLayer,\n  Marker,\n  Popup,\n  useMap,\n} from 'react-leaflet';\nimport L, { Map as LeafletMap } from 'leaflet';\nimport 'leaflet/dist/leaflet.css';\nimport { useTrackingStore } from '@/store/tracking-store';\nimport type { Vehicle } from '@/lib/types';\n\n// Fix for default marker icons not appearing in Next.js\ndelete (L.Icon.Default.prototype as any)._getIconUrl;\nL.Icon.Default.mergeOptions({\n  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',\n  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',\n  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',\n});\n\n\n/* ================================\n   Imperative View Controller\n================================ */\nfunction ChangeView({\n  center,\n  zoom,\n}: {\n  center: [number, number];\n  zoom: number;\n}) {\n  const map = useMap();\n\n  useEffect(() => {\n    map.setView(center, zoom, { animate: true });\n  }, [center, zoom, map]);\n\n  return null;\n}\n\n/* ================================\n   Stable Icon Factory\n================================ */\nconst useVehicleIcons = () =>\n  useMemo(() => {\n    const base = {\n      iconSize: [28, 41] as L.PointExpression,\n      iconAnchor: [14, 41] as L.PointExpression,\n      popupAnchor: [0, -41] as L.PointExpression,\n      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',\n      shadowSize: [41, 41] as L.PointExpression,\n    };\n\n    return {\n      ON_TRIP: new L.Icon({ ...base, iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png' }),\n      AVAILABLE: new L.Icon({ ...base, iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png' }),\n      MAINTENANCE: new L.Icon({ ...base, iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png' }),\n      ASSIGNED: new L.Icon({ ...base, iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png' }),\n      OUT_OF_SERVICE: new L.Icon({ ...base, iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png' }),\n      SELECTED: new L.Icon({ ...base, iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png' }),\n    };\n  }, []);\n\n\n/* ================================\n   Main Map Component (Fast Refresh Safe)\n================================ */\nfunction LeafletTrackingMap({\n  vehicles,\n  center,\n  zoom = 13,\n}: {\n  vehicles: Vehicle[];\n  center: [number, number];\n  zoom?: number;\n}) {\n  const mapRef = useRef<LeafletMap | null>(null);\n  const { selectedVehicle, selectVehicle } = useTrackingStore();\n  const icons = useVehicleIcons();\n\n  /* üî• CRITICAL FIX: destroy map on unmount */\n  useEffect(() => {\n    return () => {\n      if (mapRef.current) {\n        mapRef.current.remove(); // ‚Üê THIS prevents re-init error forever\n        mapRef.current = null;\n      }\n    };\n  }, []);\n\n  return (\n    <MapContainer\n      center={center}\n      zoom={zoom}\n      style={{ height: '100%', width: '100%' }}\n      scrollWheelZoom\n      preferCanvas\n      whenCreated={(map) => {\n        mapRef.current = map;\n        // Position zoom control to the bottom left\n        map.zoomControl.setPosition('bottomleft');\n      }}\n      zoomControl={true} // Explicitly enable zoom control\n    >\n      {/* IMPORTANT: Change view without rerendering MapContainer */}\n      <ChangeView center={center} zoom={zoom} />\n\n      <TileLayer\n        url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\n        attribution=\"&copy; OpenStreetMap contributors\"\n      />\n\n      {vehicles.map((v) => {\n        const isSelected = selectedVehicle?.id === v.id;\n        const statusKey = v.status as keyof ReturnType<typeof useVehicleIcons>;\n        const icon = isSelected ? icons.SELECTED : (icons[statusKey] || icons.AVAILABLE);\n        \n        return (\n          <Marker\n            key={v.id}\n            position={[v.currentLocation.lat, v.currentLocation.lng]}\n            icon={icon}\n            eventHandlers={{\n              click: () => {\n                selectVehicle(v);\n              },\n            }}\n          >\n            <Popup>\n              <div>\n                <strong>{v.plateNumber}</strong>\n                <br />\n                Status: {v.status}\n              </div>\n            </Popup>\n          </Marker>\n        );\n      })}\n    </MapContainer>\n  );\n}\n\nexport default memo(LeafletTrackingMap);\n"],"names":[],"mappings":"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","debugId":null}}]
}